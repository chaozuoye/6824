# MIT 6.824 Lab 2: Raft 分布式一致性算法实验

## 实验概述

Lab 2 是 MIT 6.824 分布式系统课程的核心实验之一，要求实现 Raft 一致性算法。Raft 是一种用于管理复制日志的共识算法，设计目标是易于理解和实现。

## 实验目标

1. 实现 Raft 一致性算法的核心功能
2. 理解分布式系统中的一致性问题
3. 掌握领导者选举、日志复制等关键机制
4. 通过测试验证实现的正确性

## 实验内容

### Part 2A: 领导者选举 (Leader Election)

#### 核心要求
- 实现 Raft 节点的三种状态：Follower、Candidate、Leader
- 实现心跳机制和超时机制
- 实现领导者选举流程

#### 关键实现点
1. **状态管理**
   - 维护节点当前状态（Follower/Candidate/Leader）
   - 管理任期（Term）信息
   - 处理选举超时

2. **消息类型**
   - RequestVote RPC：请求投票
   - AppendEntries RPC：追加日志条目/心跳

3. **选举流程**
   ```
   Follower -> Candidate (超时)
   Candidate -> 向所有节点发送 RequestVote
   收到多数投票 -> Leader
   收到 AppendEntries (更新的任期) -> Follower
   ```

### Part 2B: 日志复制 (Log Replication)

#### 核心要求
- 实现日志条目的复制机制
- 保证日志在集群中的一致性
- 实现领导者提交日志的机制

#### 关键实现点
1. **日志结构**
   - 索引（Index）
   - 任期（Term）
   - 命令（Command）

2. **复制流程**
   - 领导者接收客户端命令
   - 将命令追加到本地日志
   - 并行发送 AppendEntries 给所有跟随者
   - 等待多数节点确认后提交

3. **安全性保证**
   - 领导者只能提交当前任期及之前的日志
   - 确保日志一致性（5个规则）

### Part 2C: 持久化 (Persistence)

#### 核心要求
- 实现 Raft 状态的持久化存储
- 在节点崩溃重启后能恢复状态
- 保证一致性语义

#### 关键实现点
1. **需要持久化的状态**
   - 当前任期（currentTerm）
   - 投票信息（votedFor）
   - 日志条目（log[]）

2. **持久化时机**
   - 更新 currentTerm 时
   - 投票时
   - 添加/删除日志条目时

3. **恢复机制**
   - 重启时从持久化存储读取状态
   - 继续之前的状态运行

## 实现指南

### 数据结构设计

```go
type Raft struct {
    mu        sync.Mutex          // 锁
    peers     []*labrpc.ClientEnd // RPC 端点
    me        int                 // 本节点索引
    dead      int32               // 节点是否死亡
    
    // 持久化状态
    currentTerm int       // 当前任期
    votedFor    int       // 投票给谁
    log         []LogEntry // 日志条目
    
    // 易失状态
    commitIndex int       // 已提交的最高日志索引
    lastApplied int       // 已应用到状态机的最高索引
    
    // 领导者使用的易失状态
    nextIndex  []int     // 发送给每个服务器的下一个日志索引
    matchIndex []int     // 复制到每个服务器的最高日志索引
}
```

### 核心算法实现

#### 领导者选举
1. 节点启动时为 Follower 状态
2. 在选举超时时间内未收到有效 RPC 则转为 Candidate
3. 增加任期，投给自己，向其他节点发送 RequestVote
4. 收到多数投票则成为 Leader
5. 开始发送心跳维持领导地位

#### 日志复制
1. 客户端请求发送到领导者
2. 领导者将命令追加到本地日志
3. 并行向跟随者发送 AppendEntries RPC
4. 收到多数确认后提交日志
5. 将结果返回给客户端

## 测试说明

### 测试用例分类

1. **基础测试**
   - 初始选举
   - 基本同意
   - 领导者失败

2. **高级测试**
   - 网络分区
   - 日志压缩
   - 持久化测试

3. **性能测试**
   - 大量请求处理
   - 网络延迟测试

### 通过标准
- 所有测试用例必须通过
- 不能有死锁或竞态条件
- 需要满足线性一致性语义

## 常见问题与解决方案

### 1. 选举安全性
**问题**：多个节点同时成为领导者
**解决方案**：确保只有一个节点能获得多数投票

### 2. 日志一致性
**问题**：节点间日志不一致
**解决方案**：实现日志回溯机制，强制跟随者日志与领导者一致

### 3. 持久化问题
**问题**：节点重启后状态不一致
**解决方案**：正确实现持久化，确保关键状态及时保存

## 调试建议

1. **逐步实现**：先完成 2A，再 2B，最后 2C
2. **日志记录**：添加详细的调试日志
3. **单元测试**：为关键函数编写单元测试
4. **并发控制**：注意锁的使用，避免死锁

## 评分标准

- 功能正确性 (70%)
- 代码质量 (20%)
- 性能优化 (10%)

## 参考资料

1. [Raft 论文](https://raft.github.io/raft.pdf)
2. [Raft 官网](https://raft.github.io/)
3. MIT 6.824 课程网站
4. 实验指导文档

## 提交要求

1. 完整的 `raft.go` 文件
2. 通过所有测试用例
3. 代码注释清晰
4. 不修改不允许修改的文件

---

**注意**：本实验难度较高，建议预留充足时间完成。重点理解 Raft 算法的核心思想和实现细节。